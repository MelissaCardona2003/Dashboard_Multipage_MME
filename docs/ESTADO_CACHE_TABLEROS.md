# Estado de Cache y Datos Hist√≥ricos por Tablero

## ‚úÖ Tableros CON datos hist√≥ricos

Estos tableros usan `fetch_metric_data()` que tiene el sistema de cache con datos hist√≥ricos:

| Tablero | P√°gina | Datos Cacheados |
|---------|--------|-----------------|
| **Generaci√≥n** | `/generacion` | ‚úÖ Reservas, Aportes, Generaci√≥n SIN |
| **Generaci√≥n por Fuentes** | `/generacion/fuentes` | ‚úÖ Generaci√≥n por Recurso (Renovable/No Renovable) |

### M√©tricas con cache hist√≥rico:
- `VolEmbalDiar/Sistema` - Reservas H√≠dricas
- `AporEner/Sistema` - Aportes H√≠dricos
- `Gene/Sistema` - Generaci√≥n SIN
- `Gene/Recurso` - Generaci√≥n por Recurso (para calcular % renovable)

---

## ‚ö†Ô∏è Tableros SIN datos hist√≥ricos (usan API directa)

Estos tableros usan `get_objetoAPI()` o `ReadDB()` directamente, **sin cache**:

| Tablero | P√°gina | Estado cuando API cae |
|---------|--------|----------------------|
| **Hidrolog√≠a** | `/generacion/hidraulica/hidrologia` | ‚ùå Sin datos |
| **M√©tricas** | `/metricas` | ‚ùå Datos de ejemplo |
| **Generaci√≥n Fuentes (gr√°ficos)** | `/generacion/fuentes` | ‚ùå Sin gr√°ficos |
| **Otros tableros** | Todos los dem√°s | ‚ùå Sin datos |

### Cantidad de usos de API directa:
- `generacion_hidraulica_hidrologia.py`: **18 llamadas** a `get_objetoAPI()`
- `generacion_fuentes_unificado.py`: **3 llamadas** a `get_objetoAPI()`
- `metricas.py`: **2 llamadas** (1 a `get_objetoAPI()`, 1 a `ReadDB()`)
- `generacion.py`: **1 llamada** a `ReadDB()` (para gr√°fico adicional)

---

## üîß Soluci√≥n: Extender Cache a Todos los Tableros

Para que TODOS los tableros usen datos hist√≥ricos, necesitamos:

### Opci√≥n 1: Migrar a `fetch_metric_data()` (Recomendado)

Cambiar todas las llamadas de:
```python
objetoAPI = get_objetoAPI()
df = objetoAPI.request_data(metric, entity, start, end)
```

Por:
```python
df = fetch_metric_data(metric, entity, start, end)
```

**Ventajas:**
- ‚úÖ Cache autom√°tico con datos hist√≥ricos
- ‚úÖ Fallback en cascada (API ‚Üí Cache ‚Üí Hist√≥rico ‚Üí Fallback)
- ‚úÖ C√≥digo m√°s simple
- ‚úÖ Menor carga en la API

**Archivos a modificar:**
1. `generacion_hidraulica_hidrologia.py` - 18 funciones
2. `generacion_fuentes_unificado.py` - 3 callbacks
3. `metricas.py` - 2 funciones
4. `generacion.py` - 1 callback adicional

### Opci√≥n 2: Crear funciones de cache espec√≠ficas

Crear wrappers para cada tipo de dato:
```python
@cached_function(cache_type='hidrologia')
def fetch_hidrologia_data(metric, entity, start, end):
    # Implementar con fallback hist√≥rico
    pass
```

**Ventajas:**
- ‚úÖ Configuraci√≥n espec√≠fica por tipo de dato
- ‚úÖ Cache m√°s granular
- ‚ö†Ô∏è M√°s c√≥digo a mantener

---

## üìä Impacto Actual

### Cuando API XM est√° CA√çDA:

| Secci√≥n | Fichas | Gr√°ficos | Tablas |
|---------|--------|----------|--------|
| `/generacion` | ‚úÖ Con hist√≥ricos | ‚ùå Sin datos | N/A |
| `/generacion/fuentes` | ‚úÖ Con hist√≥ricos | ‚ùå Sin datos | ‚ùå Sin datos |
| `/generacion/hidraulica/hidrologia` | ‚ùå Sin datos | ‚ùå Sin datos | ‚ùå Sin datos |
| `/metricas` | N/A | ‚ùå Datos ejemplo | ‚ùå Datos ejemplo |

### Cuando API XM est√° FUNCIONANDO:

| Secci√≥n | Fichas | Gr√°ficos | Tablas |
|---------|--------|----------|--------|
| Todo | ‚úÖ Datos reales | ‚úÖ Datos reales | ‚úÖ Datos reales |

---

## üéØ Recomendaci√≥n

**Migrar todos los tableros a usar `fetch_metric_data()`**

Esto garantizar√° que:
1. ‚úÖ Todos los tableros tengan datos hist√≥ricos como fallback
2. ‚úÖ Cache uniforme en toda la aplicaci√≥n
3. ‚úÖ Mejor experiencia de usuario durante ca√≠das de API
4. ‚úÖ Reducci√≥n de carga en servidores de XM

---

## üîç Verificar Estado Actual

```bash
# Ver qu√© datos est√°n cacheados
ls -lh /tmp/portal_energetico_cache/

# Ver tableros usando cache hist√≥rico
grep -r "fetch_metric_data" pages/*.py

# Ver tableros usando API directa (sin cache)
grep -r "get_objetoAPI()\|ReadDB()" pages/*.py
```

---

## ‚è≠Ô∏è Siguiente Paso

¬øQuieres que **migremos todos los tableros** para usar el sistema de cache con datos hist√≥ricos?

Esto har√≠a que TODA la aplicaci√≥n tenga datos (hist√≥ricos) incluso cuando la API de XM est√© ca√≠da.
