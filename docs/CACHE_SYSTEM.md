# Sistema de Cach√© - Portal Energ√©tico

## üéØ Objetivo

Optimizar el rendimiento de la aplicaci√≥n evitando consultas repetidas a la API de XM y reduciendo los tiempos de carga.

## ‚ú® Caracter√≠sticas Implementadas

### 1. **Cache Manager** (`utils/cache_manager.py`)

Sistema centralizado de cach√© con las siguientes capacidades:

- **Cache en memoria**: Para acceso ultra-r√°pido (microsegundos)
- **Cache en disco**: Para persistencia entre reinicios del servidor (`/tmp/portal_energetico_cache/`)
- **Expiraci√≥n autom√°tica**: Los datos expiran seg√∫n el tipo:
  - M√©tricas h√≠dricas (reservas, aportes): 1 hora
  - Datos de generaci√≥n XM: 1 hora  
  - Generaci√≥n por plantas: 2 horas
  - Listado de recursos: 12 horas (cambia poco)
  - Precios: 30 minutos

### 2. **Funci√≥n `fetch_metric_data()`** (`utils/_xm.py`)

Wrapper cacheado para consultas a la API de XM:

```python
from utils._xm import fetch_metric_data
from datetime import date, timedelta

# Esto se cachea autom√°ticamente
df = fetch_metric_data(
    metric='Gene',
    entity='Sistema', 
    start_date=date.today() - timedelta(days=7),
    end_date=date.today()
)
```

**Beneficios:**
- Primera llamada: consulta API (puede tardar)
- Llamadas posteriores: retorna desde cach√© (instant√°neo)
- Si la API falla: usa datos previamente cacheados

### 3. **Datos H√≠dricas con Cache** (`pages/generacion.py`)

La funci√≥n `obtener_metricas_hidricas()` ahora:

1. Intenta obtener datos reales de la API (con cach√©)
2. Si hay datos cacheados, los usa aunque la API falle
3. Si no hay cach√© ni API, usa datos de fallback

### 4. **Datos XM con Cache** (`pages/generacion_fuentes_unificado.py`)

La funci√≥n `crear_fichas_generacion_xm_fallback()` ahora:

1. Consulta `Gene/Recurso` con cach√© autom√°tico
2. Calcula porcentajes renovable/no renovable
3. Usa valores reales si est√°n disponibles
4. Fallback a valores est√°ticos solo si no hay cach√©

## üöÄ Uso del Sistema de Cach√©

### Poblar Cache Inicial

Si la API de XM no est√° disponible, puedes poblar el cach√© con datos simulados:

```bash
cd /home/admonctrlxm/server
python3 scripts/poblar_cache.py
```

Esto crear√° datos simulados para:
- Reservas h√≠dricas
- Aportes h√≠dricos  
- Generaci√≥n total
- Generaci√≥n por recurso

### Limpiar Cache

Para limpiar todo el cach√©:

```python
from utils.cache_manager import clear_cache

# Limpiar todo
clear_cache()

# Limpiar solo un tipo espec√≠fico
clear_cache(cache_type='metricas_hidricas')
```

Desde terminal:

```bash
# Limpiar archivos de cach√© en disco
rm -rf /tmp/portal_energetico_cache/*

# Reiniciar Gunicorn para limpiar cach√© en memoria
sudo systemctl restart gunicorn
```

### Ver Estad√≠sticas del Cache

```python
from utils.cache_manager import get_cache_stats

stats = get_cache_stats()
print(f"Items en memoria: {stats['memory_items']}")
print(f"Items en disco: {stats['disk_items']}")
print(f"Tama√±o total: {stats['total_size_mb']:.2f} MB")
```

### Limpiar Cache Expirado

```python
from utils.cache_manager import cleanup_old_cache

# Eliminar solo archivos expirados
cleaned = cleanup_old_cache()
print(f"Archivos limpiados: {cleaned}")
```

## üìä M√©tricas de Rendimiento

### Sin Cache

- **Primera carga**: 10-30 segundos (esperando API)
- **Timeout**: 504 Gateway Timeout si API > 5s
- **Recargas**: Siempre consulta API (lento)

### Con Cache

- **Primera carga**: 10-30 segundos (poblando cach√©)
- **Recargas**: < 1 segundo (desde cach√©)
- **Sin API**: Funciona con datos cacheados
- **Beneficio**: **30x m√°s r√°pido** en recargas

## üîß Configuraci√≥n

### Tiempos de Expiraci√≥n

Editar en `utils/cache_manager.py`:

```python
CACHE_EXPIRATION = {
    'metricas_hidricas': timedelta(hours=1),      # Cambiar aqu√≠
    'generacion_xm': timedelta(hours=1),
    'generacion_plantas': timedelta(hours=2),
    'listado_recursos': timedelta(hours=12),
    'precios': timedelta(minutes=30),
    'default': timedelta(hours=1)
}
```

### Ubicaci√≥n del Cache

Cambiar directorio en `utils/cache_manager.py`:

```python
CACHE_DIR = "/tmp/portal_energetico_cache"  # Cambiar aqu√≠
```

## üêõ Troubleshooting

### El cache no funciona

1. Verificar permisos del directorio:
```bash
sudo chmod 777 /tmp/portal_energetico_cache/
ls -la /tmp/portal_energetico_cache/
```

2. Ver logs de cach√©:
```bash
sudo journalctl -u gunicorn -f | grep -i cache
```

3. Verificar que existen archivos `.pkl`:
```bash
ls -lh /tmp/portal_energetico_cache/
```

### Los datos no se actualizan

El cach√© est√° funcionando! Los datos se actualizar√°n cuando expire el cach√© (seg√∫n configuraci√≥n).

Para forzar actualizaci√≥n:
```bash
# Limpiar cach√©
rm -rf /tmp/portal_energetico_cache/*

# Reiniciar aplicaci√≥n
sudo systemctl restart gunicorn
```

### API de XM ca√≠da

Si la API de XM no responde:

1. Poblar cache con datos simulados:
```bash
python3 scripts/poblar_cache.py
```

2. Reiniciar Gunicorn:
```bash
sudo systemctl restart gunicorn
```

3. Los tableros mostrar√°n datos simulados en lugar de "fallback"

## üìù Logs √ötiles

Verificar uso de cach√©:
```bash
# Ver hits/misses
sudo journalctl -u gunicorn -f | grep "Cache HIT\|Cache MISS"

# Ver consultas a API
sudo journalctl -u gunicorn -f | grep "Consultando"

# Ver datos guardados en cach√©
sudo journalctl -u gunicorn -f | grep "Guardado en cache"
```

## ‚úÖ Ventajas del Sistema

1. **Rendimiento**: 30x m√°s r√°pido en recargas de p√°gina
2. **Resiliencia**: Funciona aunque la API est√© ca√≠da
3. **Optimizaci√≥n**: Reduce carga en servidor XM
4. **Flexibilidad**: Configurable por tipo de dato
5. **Transparente**: No requiere cambios en c√≥digo existente

## üîÑ Pr√≥ximas Mejoras

- [ ] Cache distribuido (Redis) para m√∫ltiples workers
- [ ] Precargar cache autom√°ticamente cada hora
- [ ] Dashboard de m√©tricas de cache
- [ ] Compresi√≥n de archivos de cache
- [ ] Invalidaci√≥n selectiva por fecha
