#!/bin/bash

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Script de Setup RÃ¡pido - WhatsApp Bot
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸ¤– WhatsApp Bot - Portal EnergÃ©tico MME"
echo "  Setup y ConfiguraciÃ³n Inicial"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Colores
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# FunciÃ³n de ayuda
print_step() {
    echo -e "${GREEN}[âœ“]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

print_error() {
    echo -e "${RED}[âœ—]${NC} $1"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1. Verificar dependencias
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "ğŸ“¦ Verificando dependencias del sistema..."

# Verificar Python
if ! command -v python3 &> /dev/null; then
    print_error "Python 3 no estÃ¡ instalado"
    exit 1
fi
print_step "Python 3 $(python3 --version | cut -d' ' -f2) encontrado"

# Verificar pip
if ! command -v pip3 &> /dev/null; then
    print_error "pip3 no estÃ¡ instalado"
    exit 1
fi
print_step "pip3 encontrado"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 2. Crear entorno virtual
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "ğŸ Configurando entorno virtual..."

if [ -d "venv" ]; then
    print_warning "Entorno virtual ya existe, saltando creaciÃ³n"
else
    python3 -m venv venv
    print_step "Entorno virtual creado"
fi

# Activar entorno
source venv/bin/activate
print_step "Entorno virtual activado"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 3. Instalar dependencias
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "ğŸ“š Instalando dependencias..."

pip install --upgrade pip > /dev/null 2>&1
pip install -r requirements.txt
print_step "Dependencias instaladas"

# Descargar modelo spaCy
echo ""
echo "ğŸ”¤ Descargando modelo de lenguaje espaÃ±ol..."
python -m spacy download es_core_news_sm
print_step "Modelo spaCy instalado"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 4. Configurar .env
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "âš™ï¸  Configurando variables de entorno..."

if [ -f ".env" ]; then
    print_warning "Archivo .env ya existe"
    read -p "Â¿Deseas sobrescribirlo? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        cp .env.example .env
        print_step "Archivo .env creado desde plantilla"
    fi
else
    cp .env.example .env
    print_step "Archivo .env creado desde plantilla"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 5. Crear directorios necesarios
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "ğŸ“ Creando directorios..."

mkdir -p logs
mkdir -p data
mkdir -p celery_data

print_step "Directorios creados"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 6. ConfiguraciÃ³n interactiva (opcional)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "ğŸ”§ ConfiguraciÃ³n de credenciales"
echo ""
read -p "Â¿Deseas configurar credenciales ahora? (y/N): " -n 1 -r
echo

if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo ""
    echo "ğŸ“± Credenciales Twilio (obtener en https://console.twilio.com):"
    read -p "TWILIO_ACCOUNT_SID: " twilio_sid
    read -p "TWILIO_AUTH_TOKEN: " twilio_token
    
    echo ""
    echo "ğŸ¤– API Key de Groq (obtener en https://console.groq.com):"
    read -p "GROQ_API_KEY: " groq_key
    
    # Actualizar .env
    if [ -n "$twilio_sid" ]; then
        sed -i "s/TWILIO_ACCOUNT_SID=.*/TWILIO_ACCOUNT_SID=$twilio_sid/" .env
    fi
    if [ -n "$twilio_token" ]; then
        sed -i "s/TWILIO_AUTH_TOKEN=.*/TWILIO_AUTH_TOKEN=$twilio_token/" .env
    fi
    if [ -n "$groq_key" ]; then
        sed -i "s/GROQ_API_KEY=.*/GROQ_API_KEY=$groq_key/" .env
    fi
    
    print_step "Credenciales guardadas en .env"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 7. Verificar instalaciÃ³n
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "âœ… Verificando instalaciÃ³n..."

python -c "import fastapi; import twilio; import openai; import plotly" 2>/dev/null
if [ $? -eq 0 ]; then
    print_step "Todas las dependencias principales instaladas correctamente"
else
    print_error "Algunas dependencias faltan, verifica el log arriba"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 8. Instrucciones finales
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "  ${GREEN}âœ… Setup completado exitosamente!${NC}"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“ PrÃ³ximos pasos:"
echo ""
echo "1. Editar .env con tus credenciales:"
echo "   nano .env"
echo ""
echo "2. Iniciar el bot en modo desarrollo:"
echo "   source venv/bin/activate"
echo "   uvicorn app.main:app --reload --port 8001"
echo ""
echo "3. O con Docker Compose (recomendado):"
echo "   docker-compose up -d"
echo ""
echo "4. Exponer webhook para testing (en otra terminal):"
echo "   ngrok http 8001"
echo ""
echo "5. Configurar webhook en Twilio Console:"
echo "   https://console.twilio.com â†’ Messaging â†’ WhatsApp Sandbox"
echo "   URL: https://xxxx.ngrok.io/webhook/whatsapp"
echo ""
echo "ğŸ“š DocumentaciÃ³n completa en:"
echo "   - README.md"
echo "   - ../docs/ARQUITECTURA_WHATSAPP_BOT_COMPLETO.md"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
